.global start

.section ".text"

#define SIZE	130

#define answer	x12
#define xret	x0
#define wret	w0

#define row	x2
#define column	x3
#define wrow	w2
#define wcolumn	w3

#define wdir	w4
#define dir	x5

#define scratch		x9
#define scratch1	x10

#define arg		x6
#define warg		w6

#define wscratch		w9
#define wscratch1		w10

exit:
	mov	x8, 93
	svc	#0

load_2d:
	mov	wscratch, #SIZE
	umaddl	scratch, wrow, wscratch, column

	adr	scratch1, input
	ldrb	w0, [scratch1, scratch]
	ret

// arg -> value to store
store_2d:
	mov	wscratch, #SIZE
	umaddl	scratch, wrow, wscratch, column

	adr	scratch1, input
	strb	warg, [scratch1, scratch]
	ret

scan_start:
	stp	x29, x30, [sp, #-16]!
	mov	x29, sp

	mov	row, xzr
	mov	column, xzr

loop:
	bl	load_2d

	cmp	wret, '^'
	mov	dir, #0
	b.eq	found
	cmp	wret, '>'
	mov	dir, #3
	b.eq	found
	cmp	wret, '<'
	mov	dir, #2
	b.eq	found
	cmp	wret, 'v'
	mov	dir, #1
	b.eq	found

	add	column, column, #1
	cmp	column, #SIZE
	b.ne	loop

next_line:
	mov	column, xzr
	add	row, row, #1
	b	loop

found:
	ldp	x29, x30, [sp], #16
	ret


// Marks place as 'X'
mark:
	stp	x29, x30, [sp, #-16]!
	mov	x29, sp
	bl	load_2d
	cmp	w0, '.'

	// Increase answer if stepped on '.'
	cinc	answer, answer, eq

	// Mark with 'X' if it's new
	mov	arg, 'X'
	bl	store_2d

	ldp	x29, x30, [sp], #16
	ret


// Move to "dir" one step, marking place and checking bounds
move:
	stp	x29, x30, [sp, #-16]!
	mov	x29, sp

move_mark:
	// Mark place
	bl	mark

move_no_mark:
	// load jump table
	adr	scratch, jump_tbl_move
	ldr	scratch, [scratch, dir, lsl 3]
	br	scratch

up_move:
	sub	row, row, #1
	b	step
down_move:
	add	row, row, #1
	b	step
left_move:
	sub	column, column, #1
	b	step
right_move:
	add	column, column, #1
	b	step

step:
	mov	x0, answer
	cmp	row, #(SIZE - 1)
	b.gt	exit
	cmp	column, #SIZE
	b.gt	exit

	// if we stepped on '#', then undo and turn 90
	bl	load_2d
	cmp	wret, '#'
	b.ne	move_mark

	adr	scratch, jump_tbl_undo
	ldr	scratch, [scratch, dir, lsl 3]
	br	scratch

up_un:
	add	row, row, #1
	mov	dir, #3
	b	move_no_mark
down_un:
	sub	row, row, #1
	mov	dir, #2
	b	move_no_mark
left_un:
	add	column, column, #1
	mov	dir, #0
	b	move_no_mark
right_un:
	sub 	column, column, #1
	mov	dir, #1
	b	move_no_mark

stop_move:
	ldp	x29, x30, [sp], #16
	ret

start:
	adr	x0, stack_top
	mov	sp, x0
	mov	answer, xzr

	bl	scan_start

	// At this point row and column point to start of the direction
	bl	move

	b	exit

.section ".rodata", "a", @progbits
jump_tbl_move:
.quad	up_move, down_move, left_move, right_move
jump_tbl_undo:
.quad	up_un, down_un, left_un, right_un


.section ".data", "aw", @progbits
.global input
input:
.ascii "..........#....#..........#......#.......................#...#..........................................#.........................\
...................#.........#......#.....#.......................#......................#...#....................................\
...........#..#....................................................#..........................#................#......#...........\
.....#.#...........................................................................#..........#................#..................\
...#..........................................#...........................#....................#..#.........#.....................\
...........#.#...#..........#...............#..................#.............#...................................#............#...\
......................................................................................................................#..#......#.\
....................#..........#.........#.....#.......#....#........................................#..#..........#...........#..\
....................#......#...................................................#............................................#.....\
..................................................#.........................#...........................#...............#.........\
#....#....#..................#.........#..#...................#.........#....#.....#.#........................................#...\
...........................................#..............................................................#.......................\
#...............................................................................................#...............#...........##....\
...#......#.............#...............#.....#........................................#.#........#...........#...#...............\
#........#......#............................#.......................#............#...........................#...................\
............#................................................#....................................................#...............\
.......#.................#......................#.....................#..........#................................................\
.......................................................................................#.....#......#.............................\
...........................#..#....#.......................#.............................................#...#......#.............\
........#........##...#.....................................................#...........................................#.#.......\
...............................#.........#......................#...........#..........#.....#...........#.#.................#....\
..#.#.............#................................................................................#..................#...........\
.....................#.................#............................................#...................#...................#.#.#.\
........#...........................................................................................#............##...............\
........................................................#........................................................##...............\
..#........#.................#...............#......#..........................................#................#.................\
..................#......#.............................#.............................#.....................#...#........#........#\
....................................#.#.........#..#...............#...............#..............................................\
...##..................................................................#....#..............#.#...............................#....\
...........#....#...#........#..............................................#.......#.............................................\
.................................#.............................#...................................................#..............\
..........#.............................#.....#...............#..........................................##...............#.......\
...........................................#......##...............#..............#.............................#...#............#\
.#.#.....................#........#........................................................#..........#.........#.................\
.............#.......................................##..........#.#..........................................................#...\
.............#....................................................................................................................\
..................##.....#......#........................#......................#........#........................................\
.........................................................................................#.....#............#....................#\
.#...........#....................................#.#.....................................................#......#...#............\
#.#...#....................................................................................#............................##.......#\
...#...............#................#...#...#.......................#................................#.#....#.....................\
................................#........................................#...................#....................................\
...#..#.........#......#......................#..#.....................#..........................................................\
.................................................................#.......#........................................#...............\
..................................##.......................##........................................#............................\
....#....#.............#........................................................#....#.......#....................#..............#\
.........##.............................................................#..#.#.....#...........##.................................\
....#.........................................#......#.......................#....#..............................#...........#....\
.##.....#...........................#........#...................................................#....#...........................\
...........................................................#.....#.#...................#......................#......#............\
....#............#......................................................#.......#............................................#....\
#.......................#..........#.#............................#........#..................................................#...\
#....................#.....#......................................................#....................................#.....#....\
...#.....#.....#.................#...........#...............................................#....................................\
...........................#..........................#............#............#...........................................#.....\
.......#.....#..........#........#...................................................................................#........#...\
#.....................................#......................................#.............................#......#...............\
#.....#....................#.........................................................#................#...........................\
.........................................................#....#............#..##.....................#............................\
...#..............#.................................#.......#...................................................................#.\
............................#........#...........#.......................#.......................#..........#..........#..........\
....#..............#.............................................................................#.........#.....#...........#....\
..........#................#.........................................#.#..#......................................#...#............\
............#...............................................................................................#.#.......#......#..#.\
.#................................#...............#.........................#............................................#........\
....................................................#.......................#........#........................#.................#.\
..###...............#...............#..........................................#.............#...............#..#.#...............\
..#...#.......................................#...................................................................#...#...........\
..........#..........#..#......#.............................................#......#..................#...................#.....#\
.......#.....#.......#.......#.....................................................................................#..........#.#.\
#........................#..#......................................................#......#...........#................##.........\
....#.....................#...........................................................................#...........................\
.......................#..........................#.............................................................................#.\
.........#..............#...................#................#.........................#..........#...............................\
.........#...........................................................#................................................#......#....\
.................#.....#................#.............................................................#...................#......#\
....................#.....................................................#...................................................#...\
............##.................#...................#................#.......................................................#.....\
.........................#............#.#..........................................................................#........#.....\
............#.........#........................#..............................................##....#.......................#.....\
......#...................................................#..##................^......#...#.......................................\
............#.....................................................#..............#.##.....#...............................##......\
....................#...................#......#......#......................................................#.....#...#..........\
..........................................................................#....#..........#........#..............................\
.#.................................................#..............................................................................\
.......................#.............................................................#.....#..................#.................#.\
...#...............#.#................................#..............................#.....#..#.....#..........#...............#..\
...........................................#.............#................................................................#.......\
#..............#................................................................................................................#.\
..................................#.#................##..............#......#..................#......................#...........\
..........#...................................#..................................................#................#............#..\
....#.....................#......................#.....#.........#........#................#....#.................................\
................................................#......................#.....#....................................................\
......#.....#.........................#..........................................................................................#\
............................................#..............#.................................#......................#.............\
...#......#................................#...............#................................................#.....#...............\
#...............#.........................#.#..........................................................#......................#...\
..#........#......................#.........#............#...###.........#....................................................#...\
............#.....................#........................................#..............#.........#........#....................\
...#....#...........................................#.................#...............#.........................#.................\
......#........................#..................................................................................................\
...#..........................................#....................................................#...........#....##.#.........#\
....................#..........................#....#..#...........................................................#..............\
.....#...........#.........................#...............#..........................................#..#.#.....................#\
................#.......#......#.............................................................#...#................................\
...........#....#........##.....................#.....#.....#.....#.........................................................#.....\
.#.#.........................#...#......#................................#.......##......#..........#...#..........##.............\
...................#...................#......#............................................#...........#.......................#..\
..............#.#.................................#.....................................................................#.........\
......#............#...................................##....................................#...................#.#..............\
......................#.............................#....................................................#...............#........\
..........................#.......................................................................#.......##...#..................\
...................................................#..............#...#.............#.................#..........#.#....#.........\
...#......#....................#..................................................................#...............#......#........\
....#......#.#.........#..#..#......#.....................................................#.................#.....#...............\
......#..........#............#..............#.......#..................................#.........................................\
.##.#.........................#..#.............#..........#.........................................................#.............\
.....#..#......................##...........#........................#..#.............................................#...........\
.....#...............................#................#...........................................................................\
.##....#...................#............#....................................#..............##.............#................##....\
....................#......##..............................#...#.................#...............##...#............#..............\
.................#...........................#.....................................#.#........#...........#.........#....##.......\
......#.............................##....................#......................................................................#\
...........#........##...#......#...........#................#.....................................................#..............\
......#.#.................................#...........................................................#...#......#........#.#....#\
...........#......#....#...............#.......#................#.....................#...........................................\
....#......#............................##.#...............##.#..........#.........#........#.................................#...\
.#............................#................................#.#..............................................#.....#........#..\
.#.#.......#.......#.....................................................................#..............#.................##......\
.....#.......................................#.......#........#..............#.........#................#...#...#................."

.p2align	4
stack:
	.fill 4096 * 2, 1, 0x0
stack_top:
